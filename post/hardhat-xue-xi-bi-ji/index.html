<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Hardhat 学习笔记 | Tangminjie&#39;s Blog</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://tangminjie.github.io/favicon.ico?v=1679992523643">
<link rel="stylesheet" href="https://tangminjie.github.io/styles/main.css">



<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="入门
安装
```
npm install --save-dev hardhat

npx hardhat
```

编译合约
```npx hardhat compile```

部署合约

编写js代码const Token = awa..." />
    <meta name="keywords" content="hardhat" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://tangminjie.github.io">
        <img src="https://tangminjie.github.io/images/avatar.png?v=1679992523643" class="site-logo">
        <h1 class="site-title">Tangminjie&#39;s Blog</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            首页
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            关于
          </a>
        
      
        
          <a href="https://tangminjie.github.io/tag/nEjwCuZ71/" class="site-nav">
            solidity
          </a>
        
      
        
          <a href="https://tangminjie.github.io/tag/RGPrDS_1V/" class="site-nav">
            typeScript
          </a>
        
      
        
          <a href="https://tangminjie.github.io/tag/-gUMN7ctm/" class="site-nav">
            ethers.js
          </a>
        
      
        
          <a href="https://tangminjie.github.io/tag/TCMNyywPJ" class="site-nav">
            ERC协议
          </a>
        
      
        
          <a href="https://tangminjie.github.io/tag/p44-1Shu9/" class="site-nav">
            Defi
          </a>
        
      
        
          <a href="https://tangminjie.github.io/tag/C4BAPVdND/" class="site-nav">
            Hardhat
          </a>
        
      
        
          <a href="https://tangminjie.github.io/tag/DbwJLkrIK/" class="site-nav">
            学习资料
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
          <a class="social-link" href="https://github.com/tangminjie" target="_blank">
            <i class="fab fa-github"></i>
          </a>
        
      
        
          <a class="social-link" href="https://twitter.com/Tang19010536" target="_blank">
            <i class="fab fa-twitter"></i>
          </a>
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      个人技术博客，做好当下
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://tangminjie.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Hardhat 学习笔记</h2>
            <div class="post-date">2022-10-21</div>
            
            <div class="post-content" v-pre>
              <h1 id="入门">入门</h1>
<h2 id="安装">安装</h2>
<pre><code>```
npm install --save-dev hardhat

npx hardhat
```
</code></pre>
<h2 id="编译合约">编译合约</h2>
<pre><code>```npx hardhat compile```
</code></pre>
<h2 id="部署合约">部署合约</h2>
<ol>
<li>编写js代码<pre><code>const Token = await ethers.getContractFactory(&quot;合约名&quot;);// 
    const hardhatToken = await Token.deploy();
    await hardhatToken.deployed();
    // 接下来可以直接调用合约方法 获取余额
    const ownerBalance = await hardhatToken.balanceOf(address);
</code></pre>
</li>
<li>执行js代码<pre><code>// node js文件路径
node scripts/index.js
</code></pre>
</li>
</ol>
<h2 id="常用操作">常用操作</h2>
<h3 id="fork主网">fork主网</h3>
<ol>
<li>命令的形式<pre><code>// fork eth链
// npx hardhat node --fork 地址
npx hardhat node --fork https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161

// fork指定块高度（锁定区块）
// npx hardhat node --fork 地址 --fork-block-number 块高度
npx hardhat node --fork https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161 --fork-block-number 115445
</code></pre>
</li>
<li>配置hardhat.config.js<pre><code>networks: {
    hardhat: {
    forking: {
        url: &quot;https://mainnet.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161&quot;, // okChain
        // blockNumber: 5115288, //指定fork的块高度(锁定区块)
    },
    }
},
</code></pre>
</li>
</ol>
<h3 id="重置fork">重置Fork</h3>
<p>你可以在运行时里操作Fork，如重置回全新的Fork状态、从另一个区块号Fork，或者通过调用hardhat_reset禁用Fork:</p>
<ol>
<li>重新fork<pre><code>await network.provider.request({
method: &quot;hardhat_reset&quot;,
params: [{
    forking: {
    jsonRpcUrl: &quot;https://eth-mainnet.alchemyapi.io/v2/&lt;key&gt;&quot;,
    blockNumber: 11095000
    }
}]
})
</code></pre>
</li>
<li>禁用fork<pre><code>await network.provider.request({
method: &quot;hardhat_reset&quot;,
params: []
}) 
</code></pre>
</li>
</ol>
<h2 id="挖矿">挖矿</h2>
<ol>
<li>
<p>禁用挖矿</p>
<pre><code>async function f6() {
await hardhat.network.provider.send(&quot;evm_setAutomine&quot;, [false]);
}
f6()
</code></pre>
</li>
<li>
<p>启用区间挖掘<br>
<code>await network.provider.send(&quot;evm_setIntervalMining&quot;, [5000]);</code></p>
</li>
<li>
<p>手动挖矿<br>
在hardhat.config.js没有配置手动挖矿 或 当自动挖矿被禁用时，可以执行手动挖矿（没有被禁用一样可以执行手动）</p>
<pre><code>    async function f8() {
await hardhat.network.provider.request({
    method: &quot;evm_mine&quot;,
});
}
f8()
</code></pre>
</li>
</ol>
<h3 id="获取pending中的交易列表">获取pending中的交易列表</h3>
<p>可以先禁用挖矿，再获取pending列表<br>
<code>const pendingBlock = await network.provider.send(&quot;eth_getBlockByNumber&quot;, [ &quot;pending&quot;, false, ]);</code></p>
<h3 id="删除和替换交易-hardhat_droptransaction">删除和替换交易 hardhat_dropTransaction</h3>
<ol>
<li>删除交易<pre><code>const txHash = &quot;0xabc...&quot;;
await network.provider.send(&quot;hardhat_dropTransaction&quot;, [txHash]);
</code></pre>
</li>
<li>替换交易 直接发起一个交易，指定的交易的哈希为你先覆盖的哈希即可，就像在 Geth 中一样，新的 gas/fees 价格必须至少比当前交易的 gas 价格高 10%</li>
</ol>
<h3 id="设置下一个块的时间戳">设置下一个块的时间戳</h3>
<pre><code>```
const hardhat = require(&quot;hardhat&quot;);

hardhat.network.provider.request({
method: &quot;evm_setNextBlockTimestamp&quot;,
params: [1640966400],
});
```
** 1640966400为你要设置的时间戳 场景：比如到点才能claim **
</code></pre>
<h3 id="配置项-hardhatconfigjs">配置项 hardhat.config.js</h3>
<pre><code>  networks: {
    hardhat: {
	chainId: 31337,//默认链id
	from: account,//默认账户
	gas: 'auto'|'3000',// gas费，auto自动或者一个具体的数值
	gasPrice: 'auto'|'3000', // 类似gas
	gasMultiplier: '1',用于乘以气体估计结果的数字,默认值1
	accounts: { // 此字段可以配置为以下之一
	  mnemonic: //助记池 BIP39 定义的 12 或 24 个单词的助记词。默认值：&quot;test test test test test test test test test test test junk&quot;
	  initialIndex: // 要派生的初始索引。默认值：0
	  path：所有派生密钥的 HD 父级。默认值：&quot;m/44'/60'/0'/0&quot;。
	  count: 20,要派生的帐户数。默认值：20。
	  accountsBalance: 分配给每个派生帐户的余额（以 wei 为单位）的字符串。默认值：&quot;10000000000000000000000&quot;（10000 ETH）
	  },
	blockGasLimit: gas 限制。默认值：30000000 (3gwei)
	minGasPrice: 最低 gas 价格,默认0we
	hardfork: 这个设置改变了安全帽网络的工作方式，在给定的硬分叉上模仿以太坊的主网。它必须是一个&quot;byzantium&quot;，&quot;constantinople&quot;，&quot;petersburg&quot;，&quot;istanbul&quot;，&quot;muirGlacier&quot;，&quot;berlin&quot;和&quot;london&quot;。默认值：&quot;london&quot;
	throwOnTransactionFailures：控制安全帽网络是否引发交易失败的布尔值。如果此值为true，Hardhat Network 将在事务失败时抛出组合的 JavaScript 和 Solidity 堆栈跟踪。如果是false，它将返回失败的交易哈希。在这两种情况下，交易都被添加到区块链中。默认值：true
	throwOnCallFailures：一个布尔值，用于控制 Hardhat Network 是否在调用失败时引发。如果此值为true，Hardhat Network 将在调用失败时抛出组合的 JavaScript 和 Solidity 堆栈跟踪。如果是false，它将返回调用的return data，其中可以包含还原原因。默认值：true
	loggingEnabled：控制安全帽网络是否记录每个请求的布尔值。默认值：false对于进程内 Hardhat Network 提供者，true对于 Hardhat Network 支持的 JSON-RPC 服务器（即node任务）。
	initialDate：设置区块链日期的可选字符串。有效值是Javascript 的日期时间字符串。默认值：如果不分叉另一个网络，则为当前日期和时间。当分叉另一个网络时，使用您分叉的区块的时间戳加上一秒。
	allowUnlimitedContractSize：一个可选的布尔值，禁用EIP 170强加的合约大小限制。默认值：false
	forking: {描述分叉配置的对象，可以具有以下字段：
	  url: 指向具有要分叉的状态的 JSON-RPC 节点的 URL。此字段没有默认值。必须为前叉提供它才能工作。
	  blockNumber：一个可选数字，用于固定要从哪个块中分叉。如果未提供值，则使用最新的块。
	  enabled: 一个可选的布尔值，用于打开或关闭 fork 功能。默认值：true如果url设置，false否则。
	}
	minGasPrice：gasPrice交易必须具有的最小值。如果&quot;hardfork&quot;是&quot;london&quot;或以后的，则此字段不得存在。默认值：&quot;0&quot;。
	initialBaseFeePerGas: 第baseFeePerGas一个块的。请注意，在分叉远程网络时，“第一个块”是您分叉的块之后的那个。此字段必须不存在，如果&quot;hardfork&quot;不是&quot;london&quot;或更高之一。默认值：&quot;1000000000&quot;如果不分叉。在 fork 远程网络时，如果远程网络使用 EIP-1559，则第一个本地块将baseFeePerGas根据 EIP使用权限，否则&quot;10000000000&quot;使用
	}
  }
</code></pre>
<h2 id="evm方法">EVM方法</h2>
<p>方法具体解析可以看以太坊虚拟机官方API说明 ethereum-json-rpc-api</p>
<h3 id="标准方法">标准方法</h3>
<ol>
<li>eth_accounts 返回主账户，这个账户是在hardhat.config.js配置的私钥的账户地址</li>
<li>eth_blockNumber 返回当前块高度</li>
<li>eth_call<br>
立刻执行一个新的消息调用<pre><code>    参数
    Object - 交易调用对象

    from: DATA, 20 Bytes - 发送交易的原地址，可选
    to: DATA, 20 Bytes - 交易目标地址
    gas: QUANTITY - 交易可用gas量，可选。eth_call不消耗gas，但是某些执行环节需要这个参数
    gasPrice: QUANTITY - gas价格，可选
    value: QUANTITY - 交易发送的以太数量，可选
    data: DATA - 方法签名和编码参数的哈希，可选
    QUANTITY|TAG - 整数块编号，或字符串&quot;latest&quot;、&quot;earliest&quot;或&quot;pending&quot;
</code></pre>
</li>
<li>eth_chainId 返回当前链id</li>
<li>eth_coinbase 返回接收挖矿回报的账户地址</li>
<li>eth_estimateGas 返回估计调用需要耗费的gas量</li>
<li>eth_gasPrice 返回当前的gas价格</li>
<li>eth_getBalance 获取指定账户余额</li>
<li>eth_getBlockByHash 返回具有指定哈希的块<pre><code>    params: [
hash,
true//为true时返回完整的交易对象，否则仅返回交易哈希
]
</code></pre>
</li>
<li>eth_getBlockByNumber 返回指定编号的块。<pre><code>params: [
'0x1b4', // 整数块编号，或字符串&quot;earliest&quot;、&quot;latest&quot; 或&quot;pending&quot;
true// 为true时返回完整的交易对象，否则仅返回交易哈希
]
</code></pre>
</li>
<li>eth_getBlockTransactionCountByHash 返回指定块内的交易数量，使用哈希来指定块<pre><code>    params: [
hash
]
</code></pre>
</li>
<li>eth_getBlockTransactionCountByNumber 返回指定块内的交易数量，使用块编号指定块<pre><code>    params: [
'0xe8', // 232
]
</code></pre>
</li>
<li>eth_getCode 返回指定地址的代码<pre><code>    params: [
address,
'0x2'  //整数块编号，或字符串&quot;latest&quot;、&quot;earliest&quot; 或&quot;pending&quot;
]
</code></pre>
</li>
<li>如何调用<pre><code>    const hardhat = require(&quot;hardhat&quot;);

hardhat.network.provider.request({
method: 方法名,
params: [参数],
});
</code></pre>
</li>
</ol>
<h2 id="hardhat-方法">Hardhat 方法</h2>
<ol>
<li>hardhat_addCompilationResult 添加有关已编译合同的信息</li>
<li>hardhat_dropTransaction 从内存池中删除交易</li>
<li>hardhat_impersonateAccount 模拟账户<pre><code>    async function f1(){
await hardhat.network.provider.request({
    method: &quot;hardhat_impersonateAccount&quot;,
    params: [被模拟的账户],
});
const signer = await ethers.provider.getSigner(被模拟的账户)
// 用模拟的账户给指定账户转账
await signer.sendTransaction({
    to: &quot;0x23FCB0E1DDbC821Bd26D5429BA13B7D5c96C0DE0&quot;,
    value: ethers.utils.parseEther(&quot;1.0&quot;),
});
console.log('success')

// 取消模拟
await hardhat.network.provider.request({
    method: &quot;hardhat_stopImpersonatingAccount&quot;,
    params: [被模拟的账户],
});
}

f1().then(() =&gt; process.exit(0))
.catch((error) =&gt; {
    console.error(error);
    process.exit(1);
});
</code></pre>
</li>
<li>查询交易信息<pre><code>async function UnsignedTransaction(hash) {
const data = await hardhat.ethers.provider.getTransaction(hash)
console.log('data', data)
}
//UnsignedTransaction(交易hash)
UnsignedTransaction('0xa475cf601cb72f4435b22cec9e622eaee1c98f4bd5fa39d1d7e0e69c3f5f62f5')
</code></pre>
</li>
<li>修改账户余额<pre><code>async function f2(){
await hardhat.network.provider.send(&quot;hardhat_setBalance&quot;, [
    &quot;0x23FCB0E1DDbC821Bd26D5429BA13B7D5c96C0DE0&quot;,
    Web3.utils.numberToHex(hardhat.ethers.utils.parseEther('123.12')),//十六进制,可以通过ethers.utils的转换接口
]);
}
f2()
</code></pre>
</li>
<li>Token转账<pre><code>// 代币转账
async function f4(){
// 合约部署
const ERC20 = await ethers.getContractFactory(&quot;ERC20&quot;);
let erc20 = await ERC20.deploy();
erc20.deployed();
const accounts =await ethers.getSigners();

const beforeBalance = await erc20.balanceOf(accounts[1].address)
// 设置转账数量
const amount = ethers.utils.parseEther('10')
// 广播交易
const tx = await erc20.transfer(accounts[1].address, amount)
// 等待交易上链
await tx.wait()
// 查询目标地址余额
const afterBalance = await erc20.balanceOf(accounts[1].address)

console.log('转帐前', beforeBalance.toString())
console.log('转帐后', afterBalance.toString())

}
f4()
</code></pre>
</li>
<li>ETH转账<pre><code>// 代币转账
async function f5(){
const [owner] = await ethers.getSigners();
await owner.sendTransaction({
    from: owner.address,
    to: &quot;0xD528d6B7ff1f46417a7A7b2f2869Fe0CC8e9ed67&quot;,
    value: ethers.utils.parseEther(&quot;1.2&quot;),
});
// 查询目标地址余额
const balance = await hardhat.ethers.provider.getBalance('0xD528d6B7ff1f46417a7A7b2f2869Fe0CC8e9ed67')
console.log(balance.toString())
}
f5()
</code></pre>
</li>
<li>常见单位转换<pre><code>// gas转换 num2wei
hardhat.ethers.utils.parseUnits('300', 'gwei'),

// ether转换 num2wei
hardhat.ethers.utils.parseEther('1')

// num 2 16hex
Web3.utils.numberToHex('1')
ethers.utils.hexValue(1)
</code></pre>
</li>
</ol>
<h3 id="编译配置">编译配置</h3>
<pre><code>     solidity: {
    compilers: [
    {
    version: &quot;0.5.1&quot;, // 编译器版本
    settings: {
    optimizer: {
    enabled: true,
    runs: 200
    }
    },
    ...其他配置
</code></pre>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://tangminjie.github.io/tag/C4BAPVdND/" class="tag">
                    hardhat
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://tangminjie.github.io/post/web3-qiu-zhi-wang-zhan/">
                  <h3 class="post-title">
                    WEB3 求职网站
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>






  </body>
</html>
